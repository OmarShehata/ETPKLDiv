<html>
  <title>ETPKLDiv Test Project</title>
  <style>
    canvas{
      width: 360px;
      height: 360px;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-crisp-edges;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    h1{
      margin: 0px;
    }
    button{
      width: 100px;
    }
    .full-row{
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      margin-bottom: 3px;
      margin-top: 3px;
    }
  </style>
  <body>
    <div class="full-row">
      <h1>ETP-KLDiv Demo</h1>
    </div>
    <div class="full-row">
      <canvas id="output_render"></canvas>
    </div>
    <div>
      <div class="full-row">
        <span>Iteration: </span><span id="iter-number">0</span>
        <br>
        <span> Fitness: </span><span id="fitness">0</span>
      </div>
      <div class="full-row">
        <span>Input: </span>
        <select id="input_data">
          <option value="redblack">Red & Black</option>
          <option value="whiteblack">White & Black</option>
          <option value="flower">Flowers</option>
          <option selected="selected" value="loderunner">Lode Runner</option>
          <option value="mario">Super Mario</option>
        </select>
      </div>
      <div class="full-row">
        <span>Tile Pattern Size: </span>
        <select id="tp_size">
          <option value="2">2</option>
          <option selected="selected" value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
      <div class="full-row">
        <span>Tile Pattern Warp: </span>
        <input type="checkbox" id="warp_x" checked>X</input>
        <input type="checkbox" id="warp_y">Y</input>
      </div>
      <div class="full-row">
        <span>Fixed Borders: </span>
        <input type="checkbox" id="border_top" checked>Top</input>
        <input type="checkbox" id="border_bot" checked>Bottom</input>
        <input type="checkbox" id="border_left">Left</input>
        <input type="checkbox" id="border_right">Right</input>
      </div>
      <div class="full-row">
        <span>Population: </span>
        <select id="pop_size">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="4">4</option>
          <option value="8">8</option>
        </select>
      </div>
      <div class="full-row">
        <span>Asymmetric Weight: </span><input id="novelty" min=0 max=100 value=50 type="range"></input>
      </div>
      <div class="full-row">
        <span>Temprature Noise: </span><input id="noise" min=0 max=100 value=0 type="range"></input>
      </div>
      <div class="full-row">
        <span>Number of Mutations: </span><input id="mutations" min=1 max=5 value=1 type="range"></input>
      </div>
      <div class="full-row">
        <button onclick="generateMap()">Start</button>
      </div>
    </div>
  </body>
  <script type="text/javascript" src="ETPKLDiv.js"></script>
  <script type="text/javascript">
    let outputCanvas = document.getElementById("output_render");
    outputCanvas.width = 240;
    outputCanvas.height = 240;
    let outputContext2D = outputCanvas.getContext("2d");
    outputContext2D.imageSmoothingEnabled = false;
    outputContext2D.fillStyle = "#000000";
    outputContext2D.fillRect(0,0,outputCanvas.width, outputCanvas.height);

    let animationFrameID = -1;
    let etpkldiv = new ETPKLDiv();

    let data = {};
    let inputOptions = document.getElementById("input_data");
    for(let i=0; i<inputOptions.options.length; i++){
      data[inputOptions.options[i].value] = {map:null, img:null};
      loadMapData(inputOptions.options[i].value);
      loadImageData(inputOptions.options[i].value);
    }

    function loadMapData(name){
      var rawFile = new XMLHttpRequest();
      rawFile.open("GET", "data/" + name + ".txt");
      rawFile.onreadystatechange = function (){
          if(rawFile.readyState === 4){
              if(rawFile.status === 200 || rawFile.status == 0){
                let map = [];
                let lines = rawFile.responseText.split("\n");
                for(let l of lines){
                  l = l.trim();
                  if(l.length > 0){
                    map.push([]);
                    for(let c of l){
                      map[map.length-1].push(c.charCodeAt(0) - 'a'.charCodeAt(0));
                    }
                  }
                }
                data[name]["map"] = map;
              }
          }
      }
      rawFile.send(null);
    }

    function loadImageData(name){
      let img = new Image();
      img.src = "data/" + name + ".png";
      //drawing of the test image - img1
      img.onload = function () {
        data[name]["img"] = img;
      };
    }

    function renderMap(canvas, context, graphics, map){
      context.fillRect(0,0,canvas.width,canvas.height);
      for(let y=0; y<map.length; y++){
        for(let x=0; x<map[y].length; x++){
          context.drawImage(graphics,map[y][x]*8,0,8,8,x*8,y*8,8,8);
        }
      }
    }

    function updateStep(){
      document.getElementById("iter-number").innerText = parseInt(document.getElementById("iter-number").innerText) + 1;
      document.getElementById("fitness").innerText = etpkldiv.getFitness();

      let inputData = document.getElementById("input_data");
      inputData = data[inputData[inputData.selectedIndex].value];
      let weight = parseFloat(document.getElementById("novelty").value)/100.0;
      let noise = parseFloat(document.getElementById("noise").value)/100.0;
      let mut_times = parseInt(document.getElementById("mutations").value);

      etpkldiv.step(weight, mut_times, noise);
      renderMap(outputCanvas, outputContext2D, inputData.img, etpkldiv.getMap());
    }

    function generateMap(){
      if(animationFrameID == -1){
        document.getElementById("iter-number").innerText = 0;

        let inputData = document.getElementById("input_data");
        inputData = data[inputData[inputData.selectedIndex].value];
        let tp_size = parseInt(document.getElementById("tp_size").value)
        let pop_size = parseInt(document.getElementById("pop_size").value);

        let warp_x = document.getElementById("warp_x").checked;
        let warp_y = document.getElementById("warp_y").checked;

        let border_top = document.getElementById("border_top").checked;
        let border_bot = document.getElementById("border_bot").checked;
        let border_left = document.getElementById("border_left").checked;
        let border_right = document.getElementById("border_right").checked;

        document.getElementById("input_data").disabled = true;
        document.getElementById("tp_size").disabled = true;
        document.getElementById("pop_size").disabled = true;

        document.getElementById("warp_x").disabled = true;
        document.getElementById("warp_y").disabled = true;

        document.getElementById("border_top").disabled = true;
        document.getElementById("border_bot").disabled = true;
        document.getElementById("border_left").disabled = true;
        document.getElementById("border_right").disabled = true;

        etpkldiv.initializePatternDictionary([inputData.map], tp_size,
          {"x": warp_x, "y": warp_y},
          {"left": border_left, "right": border_right, "top": border_top, "bot": border_bot});
        etpkldiv.initializeGeneration(30, 30, pop_size);
        renderMap(outputCanvas, outputContext2D, inputData.img, etpkldiv.getMap());
        animationFrameID = setInterval(updateStep, 0);
        document.getElementsByTagName('button')[0].innerText = "Stop";
      }
      else{
        document.getElementById("input_data").disabled = false;
        document.getElementById("tp_size").disabled = false;
        document.getElementById("pop_size").disabled = false;

        document.getElementById("warp_x").disabled = false;
        document.getElementById("warp_y").disabled = false;

        document.getElementById("border_top").disabled = false;
        document.getElementById("border_bot").disabled = false;
        document.getElementById("border_left").disabled = false;
        document.getElementById("border_right").disabled = false;

        clearInterval(animationFrameID);
        animationFrameID = -1;
        document.getElementsByTagName('button')[0].innerText = "Start";
      }
    }
  </script>
</html>
